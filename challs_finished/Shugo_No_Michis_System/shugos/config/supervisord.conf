[unix_http_server]
file=/tmp/supervisor.sock
chmod=0770
chown=root:editor

[rpcinterface:supervisor]
supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[supervisord]
user=root
nodaemon=true
stderr_logfile=/dev/null
stdout_logfile=/dev/null
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0


; ---------- 1) Postgres server ----------
[program:postgres]
command=%(ENV_PGBIN)s/postgres -D /var/lib/postgresql/data -c listen_addresses='127.0.0.1'
user=postgres
autostart=true
autorestart=true
priority=5
stdout_logfile=/var/log/supervisor/postgres.log
stderr_logfile=/var/log/supervisor/postgres.err
stopasgroup=true
killasgroup=true

; Database is already created during build
; ---------- 2) Rails (Puma binds to loopback 3000; Caddy is public) ----------
[program:rails]
directory=/app/core_app/web_app
command=/bin/sh -lc 'until pg_isready -h 127.0.0.1 -p 5432 -U "$DB_USER"; do echo "waiting for db..."; sleep 0.5; done; bundle exec rails db:prepare && bundle exec puma -b tcp://127.0.0.1:3000'
environment=RAILS_ENV=development,DB_HOST=127.0.0.1,DB_PORT=5432,DB_USER=postgres,DB_PASSWORD=postgres,DB_NAME=shugo_system_db,RAILS_RELATIVE_URL_ROOT=/challenge,LOGIC_TRACKER_URL=http://127.0.0.1:5000/logic/tracker,LOGIC_TRACKER_ONE_BASED=true,LOGIC_TRACKER_TIMEOUT=1
autostart=true
autorestart=true
startretries=3
priority=20
stdout_logfile=/var/log/supervisor/rails.log
stderr_logfile=/var/log/supervisor/rails.err
stopasgroup=true
killasgroup=true
user=challenger

; ---------- 3) data_parser (socket service on 127.0.0.1:9099) ----------
[program:data_parser]
directory=/app/core_app/data_parser
environment=LISTEN_HOST=127.0.0.1,LISTEN_PORT=9099,PULL_INTERVAL_SECONDS=300,DATA_DIR=/app/core_app/data_parser/data
command=/bin/bash -c 'until pg_isready -h ${PGHOST:-127.0.0.1} -p ${PGPORT:-5432}; do sleep 0.2; done; exec ./build/data_parser'
autostart=true
autorestart=true
startsecs=0
priority=12
stdout_logfile=/var/log/supervisor/data_parser.log
stderr_logfile=/var/log/supervisor/data_parser.err
environment=HOME=/home/challenger
user=challenger


; ---------- 4) Logic Tracker (127.0.0.1:5000)
[program:logic_tracker_api]
directory=/app/core_app/logic_tracker
command=/bin/sh -lc 'exec python3 main.py'
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/logic_tracker_api.log
stderr_logfile=/var/log/supervisor/logic_tracker_api.err
user=challenger

; ---------- 5) Caddy (single ingress on :1337) ----------
[program:caddy]
command=caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/supervisor/caddy.log
stderr_logfile=/var/log/supervisor/caddy.err


; ---------- 6) Editor (single ingress on :7000) ----------
;[program:editor-app]
;directory=/app/editor/backend
;user=editor
;command=/bin/sh -lc 'exec python3 app.py'
;autostart=true
;autorestart=true
;priority=10
;stdout_logfile=/app/editor/editor.log
;stderr_logfile=/app/editor/editor.err
